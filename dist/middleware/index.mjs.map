{"version":3,"sources":["../../src/utils/tokenVerify.ts","../../src/middleware/authMiddleware.ts","../../src/constants.ts","../../src/middleware/guestMode.ts"],"sourcesContent":["import { createRemoteJWKSet, jwtVerify } from 'jose';\nimport type { TokenPayload, VerifyTokenOptions } from '../types';\n\nconst jwksCache = new Map<string, ReturnType<typeof createRemoteJWKSet>>();\n\nexport function createJWKS(endpoint: string) {\n  const jwksUrl = `${endpoint}/oidc/jwks`;\n  if (!jwksCache.has(jwksUrl)) {\n    jwksCache.set(jwksUrl, createRemoteJWKSet(new URL(jwksUrl)));\n  }\n  return jwksCache.get(jwksUrl)!;\n}\n\nexport async function verifyToken(\n  token: string,\n  options: VerifyTokenOptions\n): Promise<TokenPayload> {\n  const endpoint = options.issuer.replace(/\\/oidc$/, '');\n  const JWKS = createJWKS(endpoint);\n\n  const { payload } = await jwtVerify(token, JWKS, {\n    issuer: options.issuer,\n    audience: options.audience,\n    clockTolerance: options.clockTolerance || 60,\n  });\n\n  return payload as TokenPayload;\n}\n\nexport async function verifyTokenMultiAudience(\n  token: string,\n  options: Omit<VerifyTokenOptions, 'audience'> & { audiences: string[] }\n): Promise<TokenPayload> {\n  for (const audience of options.audiences) {\n    try {\n      return await verifyToken(token, { ...options, audience });\n    } catch {\n      continue;\n    }\n  }\n  throw new Error('Token invalid for all audiences');\n}","import type { Request, Response, NextFunction } from 'express';\nimport { verifyToken, verifyTokenMultiAudience } from '../utils/tokenVerify';\nimport type { AuthUser, TokenPayload } from '../types';\n\nexport interface AuthenticatedRequest extends Request {\n  user?: AuthUser;\n  tokenPayload?: TokenPayload;\n}\n\nexport interface AuthMiddlewareOptions {\n  endpoint: string;\n  audience: string | string[];\n  getDbUserId?: (logtoId: string) => Promise<number | undefined>;\n}\n\nexport function createAuthMiddleware(options: AuthMiddlewareOptions) {\n  const { endpoint, audience, getDbUserId } = options;\n  const issuer = `${endpoint}/oidc`;\n\n  return async function authMiddleware(\n    req: AuthenticatedRequest,\n    res: Response,\n    next: NextFunction\n  ): Promise<void> {\n    try {\n      const authHeader = req.headers.authorization;\n      if (!authHeader?.startsWith('Bearer ')) {\n        res.status(401).json({ error: 'No token provided' });\n        return;\n      }\n\n      const token = authHeader.replace('Bearer ', '');\n      const payload = Array.isArray(audience)\n        ? await verifyTokenMultiAudience(token, { issuer, audiences: audience })\n        : await verifyToken(token, { issuer, audience });\n\n      const user: AuthUser = {\n        id: payload.sub,\n        email: payload.email,\n        name: payload.name,\n        picture: payload.picture,\n      };\n\n      if (getDbUserId) {\n        try {\n          user.dbUserId = await getDbUserId(payload.sub);\n        } catch (err) {\n          console.warn('Could not fetch local user ID:', err);\n        }\n      }\n\n      req.user = user;\n      req.tokenPayload = payload;\n      next();\n    } catch (error) {\n      console.error('Auth middleware error:', error);\n      res.status(401).json({ error: 'Invalid or expired token' });\n    }\n  };\n}\n\nexport const authMiddleware = createAuthMiddleware({\n  endpoint: process.env.LOGTO_ENDPOINT || 'https://auth.mustafasarac.com',\n  audience: process.env.API_RESOURCE || process.env.LOGTO_APP_ID || '',\n});\n\nexport const optionalAuthMiddleware = createAuthMiddleware({\n  endpoint: process.env.LOGTO_ENDPOINT || 'https://auth.mustafasarac.com',\n  audience: process.env.API_RESOURCE || process.env.LOGTO_APP_ID || '',\n});","export const DEFAULT_TOKEN_DURATIONS = {\n  HIGH_SECURITY: 60 * 60,        // 1 hour\n  BALANCED: 60 * 60 * 24,        // 24 hours\n  CONVENIENCE: 60 * 60 * 24 * 7, // 7 days\n} as const;\n\nexport const DEFAULT_GUEST_LIMITS = {\n  MAX_ACTIONS: 3,\n  SESSION_EXPIRY: 24 * 60 * 60 * 1000, // 24 hours\n} as const;\n\nexport const STORAGE_KEYS = {\n  GUEST_SESSION: 'mrsarac_guest_session',\n  TOKEN_DURATION_PREF: 'mrsarac_token_duration',\n} as const;","import type { Request, Response, NextFunction } from 'express';\nimport type { GuestSession } from '../types';\nimport { DEFAULT_GUEST_LIMITS } from '../constants';\n\nexport interface GuestRequest extends Request {\n  guestSession?: GuestSession;\n  isGuest?: boolean;\n}\n\nexport interface GuestMiddlewareOptions {\n  maxActions?: number;\n  sessionExpiry?: number;\n  sessionHeader?: string;\n}\n\nconst guestSessions = new Map<string, GuestSession>();\n\nexport function createGuestMiddleware(options: GuestMiddlewareOptions = {}) {\n  const {\n    maxActions = DEFAULT_GUEST_LIMITS.MAX_ACTIONS,\n    sessionExpiry = DEFAULT_GUEST_LIMITS.SESSION_EXPIRY,\n    sessionHeader = 'x-guest-session',\n  } = options;\n\n  return function guestMiddleware(\n    req: GuestRequest,\n    res: Response,\n    next: NextFunction\n  ): void {\n    const sessionId = req.headers[sessionHeader] as string | undefined;\n\n    if (!sessionId) {\n      req.isGuest = false;\n      next();\n      return;\n    }\n\n    let session = guestSessions.get(sessionId);\n\n    if (session && Date.now() - session.createdAt < sessionExpiry) {\n      session.lastActiveAt = Date.now();\n      req.guestSession = session;\n      req.isGuest = true;\n    } else if (!session) {\n      session = {\n        sessionId,\n        createdAt: Date.now(),\n        lastActiveAt: Date.now(),\n        actionsCount: 0,\n        maxActions,\n        hasUpgraded: false,\n        data: {},\n      };\n      guestSessions.set(sessionId, session);\n      req.guestSession = session;\n      req.isGuest = true;\n    } else {\n      guestSessions.delete(sessionId);\n      req.isGuest = false;\n    }\n\n    next();\n  };\n}\n\nexport function getGuestSession(sessionId: string): GuestSession | undefined {\n  return guestSessions.get(sessionId);\n}\n\nexport function isGuestMode(req: GuestRequest): boolean {\n  return req.isGuest === true;\n}"],"mappings":"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","names":["authMiddleware"]}