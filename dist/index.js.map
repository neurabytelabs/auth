{"version":3,"sources":["../src/index.ts","../src/utils/config.ts","../src/utils/tokenVerify.ts","../src/utils/userSync.ts","../src/constants.ts","../src/middleware/authMiddleware.ts","../src/middleware/guestMode.ts"],"sourcesContent":["/**\n * @mrsarac/auth - Unified Authentication Package\n */\n\n// Types\nexport type {\n  AuthConfig,\n  AuthUser,\n  TokenPayload,\n  GuestSession,\n  QuotaInfo,\n  VerifyTokenOptions,\n} from './types';\n\n// Utils\nexport { createLogtoConfig } from './utils/config';\nexport { verifyToken, createJWKS, verifyTokenMultiAudience } from './utils/tokenVerify';\nexport { syncUser, getUserByLogtoId, type QueryFunction } from './utils/userSync';\n\n// Constants\nexport { DEFAULT_TOKEN_DURATIONS, DEFAULT_GUEST_LIMITS, STORAGE_KEYS } from './constants';\n\n// Middleware (re-export from middleware module)\nexport {\n  createAuthMiddleware,\n  authMiddleware,\n  optionalAuthMiddleware,\n  type AuthenticatedRequest,\n  type AuthMiddlewareOptions,\n} from './middleware/authMiddleware';\n\nexport {\n  createGuestMiddleware,\n  getGuestSession,\n  isGuestMode,\n  type GuestRequest,\n  type GuestMiddlewareOptions,\n} from './middleware/guestMode';","import type { AuthConfig } from '../types';\n\nconst DEFAULT_CONFIG: Partial<AuthConfig> = {\n  endpoint: 'https://auth.mustafasarac.com',\n  scopes: ['openid', 'profile', 'email'],\n};\n\nexport function createLogtoConfig(config: Partial<AuthConfig> & { appId: string }): AuthConfig {\n  return {\n    ...DEFAULT_CONFIG,\n    ...config,\n    endpoint: config.endpoint || DEFAULT_CONFIG.endpoint!,\n    scopes: config.scopes || DEFAULT_CONFIG.scopes,\n  };\n}","import { createRemoteJWKSet, jwtVerify } from 'jose';\nimport type { TokenPayload, VerifyTokenOptions } from '../types';\n\nconst jwksCache = new Map<string, ReturnType<typeof createRemoteJWKSet>>();\n\nexport function createJWKS(endpoint: string) {\n  const jwksUrl = `${endpoint}/oidc/jwks`;\n  if (!jwksCache.has(jwksUrl)) {\n    jwksCache.set(jwksUrl, createRemoteJWKSet(new URL(jwksUrl)));\n  }\n  return jwksCache.get(jwksUrl)!;\n}\n\nexport async function verifyToken(\n  token: string,\n  options: VerifyTokenOptions\n): Promise<TokenPayload> {\n  const endpoint = options.issuer.replace(/\\/oidc$/, '');\n  const JWKS = createJWKS(endpoint);\n\n  const { payload } = await jwtVerify(token, JWKS, {\n    issuer: options.issuer,\n    audience: options.audience,\n    clockTolerance: options.clockTolerance || 60,\n  });\n\n  return payload as TokenPayload;\n}\n\nexport async function verifyTokenMultiAudience(\n  token: string,\n  options: Omit<VerifyTokenOptions, 'audience'> & { audiences: string[] }\n): Promise<TokenPayload> {\n  for (const audience of options.audiences) {\n    try {\n      return await verifyToken(token, { ...options, audience });\n    } catch {\n      continue;\n    }\n  }\n  throw new Error('Token invalid for all audiences');\n}","import type { AuthUser } from '../types';\n\nexport type QueryFunction = (\n  sql: string,\n  params: unknown[]\n) => Promise<{ rows: Record<string, unknown>[] }>;\n\nexport async function syncUser(\n  query: QueryFunction,\n  logtoId: string,\n  email?: string,\n  name?: string\n): Promise<number> {\n  const existing = await query('SELECT id FROM users WHERE logto_id = $1', [logtoId]);\n\n  if (existing.rows.length > 0) {\n    await query(\n      'UPDATE users SET email = COALESCE($2, email), name = COALESCE($3, name), updated_at = NOW() WHERE logto_id = $1',\n      [logtoId, email, name]\n    );\n    return existing.rows[0].id as number;\n  }\n\n  const result = await query(\n    'INSERT INTO users (logto_id, email, name) VALUES ($1, $2, $3) RETURNING id',\n    [logtoId, email, name]\n  );\n  return result.rows[0].id as number;\n}\n\nexport async function getUserByLogtoId(\n  query: QueryFunction,\n  logtoId: string\n): Promise<AuthUser | null> {\n  const result = await query(\n    'SELECT id, logto_id, email, name FROM users WHERE logto_id = $1',\n    [logtoId]\n  );\n\n  if (result.rows.length === 0) return null;\n\n  const row = result.rows[0];\n  return {\n    id: row.logto_id as string,\n    email: row.email as string | undefined,\n    name: row.name as string | undefined,\n    dbUserId: row.id as number,\n  };\n}","export const DEFAULT_TOKEN_DURATIONS = {\n  HIGH_SECURITY: 60 * 60,        // 1 hour\n  BALANCED: 60 * 60 * 24,        // 24 hours\n  CONVENIENCE: 60 * 60 * 24 * 7, // 7 days\n} as const;\n\nexport const DEFAULT_GUEST_LIMITS = {\n  MAX_ACTIONS: 3,\n  SESSION_EXPIRY: 24 * 60 * 60 * 1000, // 24 hours\n} as const;\n\nexport const STORAGE_KEYS = {\n  GUEST_SESSION: 'mrsarac_guest_session',\n  TOKEN_DURATION_PREF: 'mrsarac_token_duration',\n} as const;","import type { Request, Response, NextFunction } from 'express';\nimport { verifyToken, verifyTokenMultiAudience } from '../utils/tokenVerify';\nimport type { AuthUser, TokenPayload } from '../types';\n\nexport interface AuthenticatedRequest extends Request {\n  user?: AuthUser;\n  tokenPayload?: TokenPayload;\n}\n\nexport interface AuthMiddlewareOptions {\n  endpoint: string;\n  audience: string | string[];\n  getDbUserId?: (logtoId: string) => Promise<number | undefined>;\n}\n\nexport function createAuthMiddleware(options: AuthMiddlewareOptions) {\n  const { endpoint, audience, getDbUserId } = options;\n  const issuer = `${endpoint}/oidc`;\n\n  return async function authMiddleware(\n    req: AuthenticatedRequest,\n    res: Response,\n    next: NextFunction\n  ): Promise<void> {\n    try {\n      const authHeader = req.headers.authorization;\n      if (!authHeader?.startsWith('Bearer ')) {\n        res.status(401).json({ error: 'No token provided' });\n        return;\n      }\n\n      const token = authHeader.replace('Bearer ', '');\n      const payload = Array.isArray(audience)\n        ? await verifyTokenMultiAudience(token, { issuer, audiences: audience })\n        : await verifyToken(token, { issuer, audience });\n\n      const user: AuthUser = {\n        id: payload.sub,\n        email: payload.email,\n        name: payload.name,\n        picture: payload.picture,\n      };\n\n      if (getDbUserId) {\n        try {\n          user.dbUserId = await getDbUserId(payload.sub);\n        } catch (err) {\n          console.warn('Could not fetch local user ID:', err);\n        }\n      }\n\n      req.user = user;\n      req.tokenPayload = payload;\n      next();\n    } catch (error) {\n      console.error('Auth middleware error:', error);\n      res.status(401).json({ error: 'Invalid or expired token' });\n    }\n  };\n}\n\nexport const authMiddleware = createAuthMiddleware({\n  endpoint: process.env.LOGTO_ENDPOINT || 'https://auth.mustafasarac.com',\n  audience: process.env.API_RESOURCE || process.env.LOGTO_APP_ID || '',\n});\n\nexport const optionalAuthMiddleware = createAuthMiddleware({\n  endpoint: process.env.LOGTO_ENDPOINT || 'https://auth.mustafasarac.com',\n  audience: process.env.API_RESOURCE || process.env.LOGTO_APP_ID || '',\n});","import type { Request, Response, NextFunction } from 'express';\nimport type { GuestSession } from '../types';\nimport { DEFAULT_GUEST_LIMITS } from '../constants';\n\nexport interface GuestRequest extends Request {\n  guestSession?: GuestSession;\n  isGuest?: boolean;\n}\n\nexport interface GuestMiddlewareOptions {\n  maxActions?: number;\n  sessionExpiry?: number;\n  sessionHeader?: string;\n}\n\nconst guestSessions = new Map<string, GuestSession>();\n\nexport function createGuestMiddleware(options: GuestMiddlewareOptions = {}) {\n  const {\n    maxActions = DEFAULT_GUEST_LIMITS.MAX_ACTIONS,\n    sessionExpiry = DEFAULT_GUEST_LIMITS.SESSION_EXPIRY,\n    sessionHeader = 'x-guest-session',\n  } = options;\n\n  return function guestMiddleware(\n    req: GuestRequest,\n    res: Response,\n    next: NextFunction\n  ): void {\n    const sessionId = req.headers[sessionHeader] as string | undefined;\n\n    if (!sessionId) {\n      req.isGuest = false;\n      next();\n      return;\n    }\n\n    let session = guestSessions.get(sessionId);\n\n    if (session && Date.now() - session.createdAt < sessionExpiry) {\n      session.lastActiveAt = Date.now();\n      req.guestSession = session;\n      req.isGuest = true;\n    } else if (!session) {\n      session = {\n        sessionId,\n        createdAt: Date.now(),\n        lastActiveAt: Date.now(),\n        actionsCount: 0,\n        maxActions,\n        hasUpgraded: false,\n        data: {},\n      };\n      guestSessions.set(sessionId, session);\n      req.guestSession = session;\n      req.isGuest = true;\n    } else {\n      guestSessions.delete(sessionId);\n      req.isGuest = false;\n    }\n\n    next();\n  };\n}\n\nexport function getGuestSession(sessionId: string): GuestSession | undefined {\n  return guestSessions.get(sessionId);\n}\n\nexport function isGuestMode(req: GuestRequest): boolean {\n  return req.isGuest === true;\n}"],"mappings":"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","names":["authMiddleware"]}